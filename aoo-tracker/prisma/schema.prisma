// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./sauron.db"
}

model Events {
  id         Int      @id @default(autoincrement())
  event      String
  details    String?
  fromCol    String
  withWhom   String?
  date       String
  calculatedDate DateTime?
  territory  String   @default("Unknown Territory")
  source     String   @default("extension")

  // Foreign key to Characters
  characterId    Int      // Reference to the character who sees the event
  character      Characters @relation(fields: [characterId], references: [id])

  createdAt      DateTime @default(now())
}

model Factions {
  id   Int    @id @default(autoincrement())
  name String @unique // Ensure each faction name is unique

  // A faction can have many characters
  characters Characters[]

  // A faction can own private forums
  forums Forums[]
}

model Characters {
  id          Int      @id @default(autoincrement())
  targetId    Int      @unique // Corresponds to `targetId` in the game
  name        String
  rank        String?
  popularity  String?
  role        String?
  portraitUrl String?

  // Foreign key to Factions
  factionId Int?      // Nullable foreign key
  faction   Factions? @relation(fields: [factionId], references: [id])

  // Relationship to Events
  events Events[] // A character can see multiple events

  // Relationship to MDJHistory
  mdjHistory MDJHistory[]

  // Relationship to CharacterHistory
  storyHistory CharacterHistory[]

  // A character can create multiple topics
  topics Topics[]

  // A character can post multiple messages
  messages Messages[]

  // Relationship to CharacterLog
  logs CharacterLog[] // A character can have multiple logs

  // Relationship to Equipment
  equipment Equipment[]

  attributes CharacterAttributes?

  // Foreign key to IAUser
  userId      String?       // Foreign key linking to IAUser
  user        IAUser?       @relation("owned_characters", fields: [userId], references: [id])

  // Reciprocal field for activeCharacter relationship
  activeForUser IAUser? @relation("active_character")

  // Relationships
  chats IAChat[] // A character can have multiple chats

  createdAt   DateTime @default(now())
  @@index([targetId])
}

model Equipment {
  id          Int      @id @default(autoincrement())
  name        String   // Name of the equipment
  description String   // Description of the equipment
  type        String   // Type of equipment (e.g., "weapon", "armor", etc.)
  price       Int?     // Price of the equipment
  imageUrl    String?  // Full image URL of the equipment
  thumbnailUrl String? // Thumbnail image URL of the equipment

  // Foreign key to Characters
  characterId Int      // Character that owns this equipment
  character   Characters @relation(fields: [characterId], references: [id])
}

model MDJHistory {
  id          Int      @id @default(autoincrement())
  characterId Int      // Foreign key to the Characters table
  character   Characters @relation(fields: [characterId], references: [id])
  mdj         String   // The message content
  createdAt   DateTime @default(now()) // Timestamp of when the message was set
}

model CharacterHistory {
  id             Int         @id @default(autoincrement())
  characterId    Int         // Foreign key to the Characters table
  character      Characters  @relation(fields: [characterId], references: [id])
  story          String      // The story content
  modifiedAt     DateTime    @default(now()) // Timestamp of the modification
}

model CharacterLog {
  id          Int      @id @default(autoincrement())
  characterId Int      // Foreign key to the Characters table
  character   Characters @relation(fields: [characterId], references: [id])
  attribute   String   // Name of the changed attribute (e.g., "cc", "pv")
  oldValue    String?  // Previous value (store as a string to handle non-numeric values too)
  newValue    String?  // New value
  changedAt   DateTime @default(now()) // Timestamp of the change
}

model CharacterAttributes {
  id          Int     @id @default(autoincrement())
  characterId Int     @unique // Link to Characters table
  character   Characters @relation(fields: [characterId], references: [id]) // Only this side specifies `fields` and `references`
  cc          Int     // Capacité de Combat
  ct          Int     // Capacité de Tir
  f           Int     // Force
  e           Int     // Endurance
  agi         Int     // Agilité
  pv          Int     // Points de Vie
  pm          Int     // Points de Magie
  fm          Int     // Force Mentale
  m           Int     // Puissance magique
  a           Int     // Actions
  mvt         Int     // Mouvements
  p           Int     // Perception
  r           Int     // Récupération
  rm          Int     // Récupération Magique
  xp          Int     // Points d'expérience
  createdAt   DateTime @default(now()) // Timestamp for record creation
  updatedAt   DateTime @updatedAt      // Timestamp for last update
}

model Forums {
  id        Int       @id @default(autoincrement())
  name      String    // Name of the forum
  link      String    @unique // Link to the forum
  type      String    // Type of forum: 'RP' or 'Private'
  factionId Int?      // Foreign key to Factions (nullable for RP forums)
  faction   Factions? @relation(fields: [factionId], references: [id])

  // A forum can have many topics
  topics Topics[]
}

model Topics {
  id        Int         @id @default(autoincrement())
  name      String      // Name of the topic
  link      String      @unique // Link to the topic
  authorId  Int         // Foreign key to Characters (author of the topic)
  author    Characters  @relation(fields: [authorId], references: [id])
  forumId   Int         // Foreign key to Forums
  forum     Forums      @relation(fields: [forumId], references: [id])

  // A topic can have many messages
  messages Messages[]
}

model Messages {
  id          Int         @id @default(autoincrement())
  content     String      // Content of the message
  date        String      // Original date of the message
  createdAt   DateTime    @default(now()) // Timestamp of when the message was inserted into the DB
  characterId Int         // Foreign key to Characters (author of the message)
  character   Characters  @relation(fields: [characterId], references: [id])
  topicId     Int         // Foreign key to Topics
  topic       Topics      @relation(fields: [topicId], references: [id])
}

// IA Section

model IAUser {
  id         String       @id @default(uuid()) // UUID for unique user IDs
  username   String       @unique
  createdAt  DateTime     @default(now())      // Timestamp for user creation

  // Relationships
  activeCharacterId Int? @unique // The currently active character
  activeCharacter Characters? @relation("active_character", fields: [activeCharacterId], references: [id])
  characters Characters[] @relation("owned_characters") // One user can manage multiple characters
  documents IADocument[]
  suggestions IASuggestion[]

  @@index([activeCharacterId])
}

model IAChat {
  id          String      @id @default(uuid()) // UUID for unique chat IDs
  characterId Int         // Foreign key linking to Characters
  character   Characters  @relation(fields: [characterId], references: [id]) // Relationship with Characters
  chatType    String      // Type of chat: "gpt" or "rag" for comparison
  createdAt   DateTime    @default(now())      // Timestamp for chat creation

  // Relationships
  messages    IAMessage[]   // Messages in the chat
  votes    IAVote[]
}

model IAMessage {
  id         String    @id @default(uuid()) // UUID for unique message IDs
  chatId     String    // Foreign key to Chat
  chat       IAChat      @relation(fields: [chatId], references: [id]) // Relationship with Chat
  role       String    // Role of the sender (e.g., "user", "assistant")
  content    String    // JSON content of the message (simplified for SQLite)
  createdAt  DateTime  @default(now()) // Timestamp for message creation

  // Relationships
  votes      IAVote[]    // Votes related to this message
}

model IAVote {
  chatId     String    // Foreign key to Chat
  chat       IAChat      @relation(fields: [chatId], references: [id]) // Relationship with Chat
  messageId  String    // Foreign key to Message
  message    IAMessage   @relation(fields: [messageId], references: [id]) // Relationship with Message
  isUpvoted  Boolean   // Boolean to track upvotes/downvotes

  @@id([chatId, messageId]) // Composite primary key for votes
}

model IADocument {
  id         String    @id @default(uuid()) // UUID for unique document IDs
  createdAt  DateTime  @default(now()) // Timestamp for document creation
  title      String    // Title of the document
  content    String?   // Optional content of the document
  userId     String    // Foreign key to IAUser
  user       IAUser      @relation(fields: [userId], references: [id]) // Relationship with User

  // Relationships
  suggestions IASuggestion[] // Suggestions related to the document
}

model IASuggestion {
  id              String    @id @default(uuid()) // UUID for unique suggestion IDs
  documentId      String    // Foreign key to Document
  document        IADocument  @relation(fields: [documentId], references: [id]) // Relationship with IADocument
  originalText    String    // Original text in the document
  suggestedText   String    // Suggested replacement text
  description     String?   // Optional description of the suggestion
  isResolved      Boolean   @default(false) // Whether the suggestion is resolved
  userId          String    // Foreign key to User
  user            IAUser      @relation(fields: [userId], references: [id]) // Relationship with IAUser
  createdAt       DateTime  @default(now()) // Timestamp for suggestion creation
}
